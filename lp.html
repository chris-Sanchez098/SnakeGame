<canvas id="canvas" width="300" height="300"></canvas>

<script src="web-lib/processing.js"></script>
<script src="web-lib/functional-light.js"></script>
<script>
  //Vamos a usar http://processingjs.org/
  // o https://p5js.org/reference/
  // Importamos las librerias


  let { append, cons, first, isEmpty, isList, length, rest } = functionalLight;

  const ladomapa = 600
  const universo = {
    mysnake: [{ x: 3, y: 1 }, { x: 2, y: 1 }, { x: 1, y: 1 }], direccion: { x: 1, y: 0 }, sentido: 'right',
    food: [{x: Math.floor(Math.random()*29+1), y: Math.floor(Math.random()*29+1)}], score: 0
  }


  const alto = 20
  const ancho = 20

  function map(lista, fx) {
    if (isEmpty(lista)) {
      return [];
    } return cons(fx(first(lista)), map(rest(lista), fx));
  }
  function removelast(lista) {
    if (length(lista) == 1) {
      return [];
    } return cons(first(lista), removelast(rest(lista)));
  }
  function snakedirection(snake, direccion) {
    const cabeza = first(snake)
    return cons({ x: cabeza.x + direccion.x, y: cabeza.y + direccion.y }, removelast(snake))
  }

  function grownsnake(snake, direccion) {
    const cabeza = first(snake)
    return cons({ x: cabeza.x + direccion.x, y: cabeza.y + direccion.y }, snake)
  }

  function died(snake) {
    if (length(snake) == 1) {
      return false;
    } else if (first(snake).x == first(rest(snake)).x && first(snake).y == first(rest(snake)).y) {
      return true;
    } return (died(cons(first(snake), rest(rest(snake)))));
  }

  function make(data, attribute) {
    return Object.assign({}, data, attribute);
  }

  function choque(snake, direccion) {
    return (first(snake)).x == ladomapa / ancho  || (first(snake)).x < 0 || (first(snake)).y == ladomapa / alto || (first(snake)).y < 0;
  }

  function nomove(world, sentido) {
    return world.sentido == sentido
  }

  function eat(snake, food) {
    if ((first(snake)).y == ((first(food)).y - 1 ) && (first(snake)).x == ((first(food)).x - 1)){
        return true
    }   return false
  }

  function newfood() {
    return cons({x: (Math.floor(Math.random()*29)+1), y: Math.floor(Math.random()*29+1)}, [])
  }

  // Esta funcion pinta el snake de forma aleatoria.
  /*
  Esta configurada para pintar colores claros dentro del rango (87-255) y la entrada
  es un Math.random entre 1 y 2. Cuando la entrada es 1 pinta colores aletorios y 
  cuando la entrada es 2 pinta blanco (255). Esto para los colores no varíen tan rápido.
  */
  function colorrgb(n){
    if (n == 1){
        return (Math.floor(Math.random() * (255 - 87)) + 87);
    } {
        return 255;
    }
}
  
  function sketchProc(processing) {

    /**
     * Esto se llama antes de iniciar el juego
     */
    processing.setup = function () {
      processing.frameRate(8);
      processing.size(ladomapa, ladomapa);
      processing.background(80, 80, 100);
     // processing.img = processing.loadImage("images/fresa1.png")
      processing.state = universo;

    }


    // Dibuja algo en el canvas. Aqui se pone todo lo que quieras pintar
    processing.drawGame = function (world) {
      processing.background(80, 80, 100);
      processing.fill(240, 0, 0);
      processing.noStroke();
      (world.food).forEach(part => {
        processing.ellipse(part.x * ancho - ancho / 2, part.y * alto - alto / 2, ancho - 1, alto - 1);
      });
      processing.fill(colorrgb(Math.floor(Math.random() * 2)),
                       colorrgb(Math.floor(Math.random() * 2)), 
                       colorrgb(Math.floor(Math.random() * 2)));
      (world.mysnake).forEach(part => {
        processing.rect(part.x * ancho, part.y * alto, ancho, alto);
      });
      processing.fill(240, 240, 240)
      processing.textFont(processing.PFont, 18);
      processing.text("Score: " + world.score, ancho, ladomapa - alto); 
      //processing.image(processing.img, 1 * ancho, 1 * alto);

    }


    processing.onTic = function (world) {
      if (choque(world.mysnake) || died(world.mysnake)) {
        return make(world, { mysnake: [{ x: isNaN, y: isNaN }] });
      } else if (eat(world.mysnake, world.food)){
        return make(world, { mysnake: grownsnake(world.mysnake, world.direccion), food: newfood(), score: world.score + 1} );
      }
      return make(world, { mysnake: snakedirection(world.mysnake, world.direccion) });
    }

    processing.onKeyEvent = function (world, keyCode) {
      if (choque(world.mysnake) || died(world.mysnake)) {
        return make(world, { mysnake: [{ x: isNaN, y: isNaN }] });
      } switch (keyCode) {
        case processing.UP:
          if (world.sentido == 'down') {
            return make(world, { mysnake: snakedirection(world.mysnake, world.direccion) })
          } else {
            return make(world, { direccion: { x: 0, y: -1 }, sentido: 'up' });
          }
          break;
        case processing.DOWN:
          if (world.sentido == 'up') {
            return make(world, { mysnake: snakedirection(world.mysnake, world.direccion) })
          } else {
            return make(world, { direccion: { x: 0, y: 1 }, sentido: 'down' });
          }
          break;
        case processing.LEFT:
          if (world.sentido == 'right') {
            return make(world, { mysnake: snakedirection(world.mysnake, world.direccion) })
          } else {
            return make(world, { direccion: { x: -1, y: -0 }, sentido: 'left' });
          }
          break;
        case processing.RIGHT:
          if (world.sentido == 'left') {
            return make(world, { mysnake: snakedirection(world.mysnake, world.direccion) })
          } else {
            return make(world, { direccion: { x: 1, y: 0 }, sentido: 'right' });
          }
          break;
        case 32:
          return make(world, { mysnake: grownsnake(world.mysnake, world.direccion)});
          break;
        default:
          console.log(keyCode);
          return make(world, { mysnake: snakedirection(world.mysnake, world.direccion) })
          break;

      }
    }

    // Esta es la función que pinta todo. Se ejecuta 60 veces por segundo. 
    // No cambie esta función. Su código debe ir en drawGame
    processing.draw = function () {
      processing.drawGame(processing.state);
      processing.state = processing.onTic(processing.state);
    };

    // Esta función se ejecuta cada vez que presionamos una tecla. 
    // No cambie esta función. Su código debe ir en onKeyEvent
    processing.keyPressed = function () {
      processing.state = processing.onKeyEvent(processing.state, processing.keyCode);
    }
    // Esta función se ejecuta cada vez movemos el mouse. 
    // No cambie esta función. Su código debe ir en onKeyEvent
    processing.mouseMoved = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "move", mouseX: processing.mouseX, mouseY: processing.mouseY });
    }

    // Estas funciones controlan los eventos del mouse. 
    // No cambie estas funciones. Su código debe ir en OnMouseEvent
    processing.mouseClicked = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "click", mouseX: processing.mouseX, mouseY: processing.mouseY, mouseButton: processing.mouseButton });
    }

    processing.mouseDragged = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "drag", mouseX: processing.mouseX, mouseY: processing.mouseY, mouseButton: processing.mouseButton });
    }

    processing.mousePressed = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "press", mouseX: processing.mouseX, mouseY: processing.mouseY, mouseButton: processing.mouseButton });
    }

    processing.mouseReleased = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "release", mouseX: processing.mouseX, mouseY: processing.mouseY, mouseButton: processing.mouseButton });
    }
    processing.setSpeed = function(value) {
      processing.frameRate(value);
    }

  }

  var canvas = document.getElementById("canvas");

  // Adjuntamos nuestro sketch al framework de processing
  var processingInstance = new Processing(canvas, sketchProc);
</script>
<button onClick="processingInstance.setSpeed(10)">
  Velocidad 10
</button>
<button onClick="processingInstance.setSpeed(30)">
  Velocidad 30
</button>